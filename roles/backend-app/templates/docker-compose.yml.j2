version: '3.8'

networks:
  {{ backend_app_network }}:
    driver: bridge

services:
  db:
    image: {{ db_image }}
    container_name: {{ backend_app_name }}_db
    restart: {{ backend_app_restart_policy }}
    networks:
      - {{ backend_app_network }}
    ports:
      - "{{ db_port }}:5432"
    environment:
      POSTGRES_DB: {{ db_name }}
      POSTGRES_USER: {{ db_user }}
      POSTGRES_PASSWORD: {{ db_password }}
    volumes:
      - {{ backend_app_data_path }}/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ db_user }} -d {{ db_name }}"]
      interval: 30s
      timeout: 10s
      retries: 5

  backend:
    image: {{ backend_app_image }}:{{ backend_app_version }}
    container_name: {{ backend_app_name }}
    restart: {{ backend_app_restart_policy }}
    networks:
      - {{ backend_app_network }}
    ports:
      - "{{ backend_app_port }}:8000"
    environment:
      DATABASE_URL: {{ database_url }}
      APP_ENV: {{ app_env }}
      DEBUG: {{ debug }}
      LOG_LEVEL: {{ log_level }}
      API_V1_PREFIX: {{ api_v1_prefix }}
      CORS_ORIGINS: {{ cors_origins }}
      JWT_SECRET: {{ jwt_secret }}
      JWT_ALGORITHM: {{ jwt_algorithm }}
      JWT_EXPIRATION: {{ jwt_expiration }}
      ANTHROPIC_API_KEY: {{ anthropic_api_key }}
      OPENAI_API_KEY: {{ openai_api_key }}
      GEMINI_API_KEY: {{ gemini_api_key }}
      GEMINI_MODEL: {{ gemini_model }}
    volumes:
      - {{ backend_app_logs_path }}:/app/logs
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5